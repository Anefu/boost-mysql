<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Going async</title>
<link rel="stylesheet" href="../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets Vsnapshot">
<link rel="home" href="../index.html" title="Chapter 1. Boost.Mysql">
<link rel="up" href="../index.html" title="Chapter 1. Boost.Mysql">
<link rel="prev" href="fields.html" title="Fields">
<link rel="next" href="ssl.html" title="SSL/TLS">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr><td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="https://www.boost.org/doc/libs/1_80_0/boost.png"></td></tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="fields.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="ssl.html"><img src="../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h2 class="title" style="clear: both">
<a name="mysql.async"></a><a class="link" href="async.html" title="Going async">Going async</a>
</h2></div></div></div>
<p>
      Following <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/libs/asio/index.html" target="_top">Boost.Asio</a>'s convetion,
      all network operations have asynchronous versions with the same name prefixed
      by <code class="computeroutput"><span class="identifier">async_</span></code>. The last parameter
      to async operations is a <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/asynchronous_operations.html#boost_asio.reference.asynchronous_operations.completion_tokens_and_handlers" target="_top"><span class="emphasis"><em>CompletionToken</em></span></a>,
      which dictates how the asynchronous operation will be managed and the function's
      return type. These <code class="computeroutput"><span class="identifier">async_</span></code> functions
      are called async initiating functions.
    </p>
<p>
      Every async initiating function has an associated handler type, which dictates
      how the asynchronous operation communicates its result back to the caller.
      This handler type always has one of the two folling forms:
    </p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
          <code class="computeroutput"><span class="keyword">void</span><span class="special">(</span><span class="identifier">error_code</span><span class="special">)</span></code>.
          Used in operations that do not have a proper result, e.g. <a class="link" href="ref/boost__mysql__connection/async_connect.html" title="connection::async_connect"><code class="literal">connection::async_connect</code></a>.
        </li>
<li class="listitem">
          <code class="computeroutput"><span class="keyword">void</span><span class="special">(</span><span class="identifier">error_code</span><span class="special">,</span>
          <span class="identifier">T</span><span class="special">)</span></code>.
          Used in operations that have a result, e.g. <a class="link" href="ref/boost__mysql__resultset/async_read_one.html" title="resultset::async_read_one"><code class="literal">resultset::async_read_one</code></a>
          (in this case, <code class="computeroutput"><span class="identifier">T</span></code> is <code class="computeroutput"><span class="keyword">bool</span></code> for the "owning" version).
        </li>
</ol></div>
<p>
      As noted <a class="link" href="error_handling.html" title="Error handling and available overloads">here</a>, all asynchronous
      are overloaded to accept an optional <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>
      output parameter, which is set before calling the completion handler, and is
      populated with diagnostic information, if available.
    </p>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.reads_writes"></a><a class="link" href="async.html#mysql.async.reads_writes" title="Stream reads and writes">Stream reads and writes</a>
</h3></div></div></div>
<p>
        As mentioned in <a class="link" href="overview.html#mysql.overview.async" title="Asynchronous functions and multi-threading">this section</a>,
        only a single read and a single write operation per connection can be outstanding
        at a given point in time. If you need to perform queries in parallel, open
        more connections to the server.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.proxy_io"></a><a class="link" href="async.html#mysql.async.proxy_io" title="Proxy I/O objects">Proxy I/O objects</a>
</h3></div></div></div>
<p>
        <a class="link" href="ref/boost__mysql__resultset.html" title="resultset"><code class="literal">resultset</code></a>
        and <a class="link" href="ref/boost__mysql__statement.html" title="statement"><code class="literal">statement</code></a>
        are proxy I/O objects. This means that they don't own a separate <code class="computeroutput"><span class="identifier">Stream</span></code> object, but rather rely on an underlying
        <a class="link" href="ref/boost__mysql__connection.html" title="connection"><code class="literal">connection</code></a>
        to perform I/O. This has the following implications:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
            To use a <code class="computeroutput"><span class="identifier">resultset</span></code> or
            a <code class="computeroutput"><span class="identifier">statement</span></code> for operations
            that involve I/O, the <code class="computeroutput"><span class="identifier">connection</span></code>
            object that created them must be alive and open.
          </li>
<li class="listitem">
            Read and write operations on these objects count towards the limit of
            one concurrent read and write operation per connection.
          </li>
<li class="listitem">
            I/O operations on these objects end up mutating the underlying <code class="computeroutput"><span class="identifier">connection</span></code>'s state. In a multi-threaded
            environment, appropriate guards must be in place to avoid race conditions.
            This applies among all proxy I/O objects for a single connection; different
            connections share no state.
          </li>
</ul></div>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.ops"></a><a class="link" href="async.html#mysql.async.ops" title="Protocol operations">Protocol operations</a>
</h3></div></div></div>
<p>
        The MySQL protocol is a half-duplex request/reply protocol that has the concept
        of "operations". This library models some operations as single
        functions (e.g. <a class="link" href="ref/boost__mysql__connection/prepare_statement.html" title="connection::prepare_statement"><code class="literal">connection::prepare_statement</code></a>),
        and splits other operations into several calls (e.g. <a class="link" href="ref/boost__mysql__connection/query.html" title="connection::query"><code class="literal">connection::query</code></a>
        + <a class="link" href="ref/boost__mysql__resultset/read_all.html" title="resultset::read_all"><code class="literal">resultset::read_all</code></a>),
        to provide more flexibility.
      </p>
<p>
        Once you engage in a multi-function operation, you must complete it (e.g.
        by calling <code class="computeroutput"><span class="identifier">resultset</span><span class="special">::</span><span class="identifier">read_xxx</span></code> until all rows have been read)
        before engaging into the next one. Failing to do so will produce network
        packet mismatches, resulting in undefined behavior.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.completion_tokens"></a><a class="link" href="async.html#mysql.async.completion_tokens" title="Completion tokens">Completion tokens</a>
</h3></div></div></div>
<p>
        Any completion token you may use with Boost.Asio can also be used with this
        library. Here are some of the most common:
      </p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; ">
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong>Callbacks</strong></span>. You can pass in a callable
            (function pointer, function object) with the same signature as the handler
            signature specified for the operation. The handler will be called when
            the operation completes. The initiating function will return <code class="computeroutput"><span class="keyword">void</span></code>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_callbacks.html" title="Text query, async with callbacks">This example</a>
            demonstrates asynchronous text queries with callbacks.
          </p>
</li>
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong>Futures</strong></span>. In this case, you pass in the
            constant <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/use_future.html" target="_top"><code class="literal">boost::asio::use_future</code></a>
            as completion token. The initiating function will return one of the following:
            <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; ">
<li class="listitem">
                  <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">&gt;</span></code>,
                  if the completion handler has the form given by 1).
                </li>
<li class="listitem">
                  <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;</span></code>,
                  if the completion handler has the form given by 2).
                </li>
</ul></div>
          </p>
<p class="simpara">
            You can wait for the future by calling <code class="computeroutput"><span class="identifier">future</span><span class="special">::</span><span class="identifier">get</span></code>.
            If an error occurs, <code class="computeroutput"><span class="identifier">future</span><span class="special">::</span><span class="identifier">get</span></code>
            will throw an exception. Note that the exception will <span class="bold"><strong>not</strong></span>
            contain the extra information stored in the <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_futures.html" title="Text query, async with futures">This example</a>
            demonstrates using futures with async queries.
          </p>
</li>
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong><a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/libs/coroutine/index.html" target="_top">Boost.Coroutine</a>
            coroutines</strong></span>. In this case, you pass in a <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/yield_context.html" target="_top"><code class="literal">boost::asio::yield_context</code></a>.
            To obtain one of these, you should use <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/spawn.html" target="_top"><code class="literal">boost::asio::spawn</code></a>
            to create a new coroutine. The initiating function will return:
            <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; ">
<li class="listitem">
                  <code class="computeroutput"><span class="keyword">void</span></code>, if the completion
                  handler has the form given by 1).
                </li>
<li class="listitem">
                  <code class="computeroutput"><span class="identifier">T</span></code>, if the completion
                  handler has the form given by 2).
                </li>
</ul></div>
          </p>
<p class="simpara">
            If you use <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/basic_yield_context/operator_lb__rb_.html" target="_top"><code class="literal">boost::asio::yield_context::operator[]</code></a>,
            the operation will set the given <a class="link" href="ref/boost__mysql__error_code.html" title="error_code"><code class="literal">error_code</code></a>
            when it fails. Otherwise, the function will throw a exception. Note that
            this exception will not contain the extra information stored in the
            <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_coroutines.html" title="Text query, async with Boost.Coroutine coroutines">This example</a>
            uses <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/libs/coroutine/index.html" target="_top">Boost.Coroutine</a>
            coroutines with async queries.
          </p>
</li>
<li class="listitem">
<p class="simpara">
            <span class="bold"><strong>C++20 coroutines</strong></span>. In this case, you
            pass in the constant <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/use_awaitable.html" target="_top"><code class="literal">boost::asio::use_awaitable</code></a>
            as completion token. The initiating function will return:
            <div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; ">
<li class="listitem">
                  <code class="literal"><a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/awaitable.html" target="_top"><code class="literal">boost::asio::awaitable&lt;void&gt;</code></a></code>,
                  if the completion handler has the form given by 1).
                </li>
<li class="listitem">
                  <code class="literal"><a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/awaitable.html" target="_top"><code class="literal">boost::asio::awaitable&lt;T&gt;</code></a></code>,
                  if the completion handler has the form given by 2).
                </li>
</ul></div>
          </p>
<p class="simpara">
            You can then use <code class="computeroutput"><span class="identifier">co_await</span></code>
            on this return value. If the operation fails, <code class="computeroutput"><span class="identifier">co_await</span></code>
            will throw an exception. Note that this exception will not contain the
            extra information stored in the <a class="link" href="ref/boost__mysql__error_info.html" title="error_info"><code class="literal">error_info</code></a>.
          </p>
<p class="simpara">
            <a class="link" href="examples/query_async_coroutinescpp20.html" title="Text query, async with C++20 coroutines">This example</a>
            demonstrates using C++20 coroutines to perform text queries.
          </p>
</li>
<li class="listitem">
            Any other type that satisfies the <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/asynchronous_operations.html#boost_asio.reference.asynchronous_operations.completion_tokens_and_handlers" target="_top"><span class="emphasis"><em>CompletionToken</em></span></a>
            type requirements. We have listed the most common ones here, but you
            can craft your own and use it with this library's async operations.
          </li>
</ul></div>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.default_completion_tokens"></a><a class="link" href="async.html#mysql.async.default_completion_tokens" title="Default completion tokens">Default completion
      tokens</a>
</h3></div></div></div>
<p>
        <a class="ulink" href="https://anarthal.github.io/boost/index.html" target="_top">Boost.Mysql</a>
        also supports default completion tokens. Recall that some stream types may
        have an associated <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/Executor1.html" target="_top"><span class="emphasis"><em>Executor</em></span></a>
        that has an associated default completion token type (see [asiorelink default_completion_token
        default_completion_token]). If this is the case, you don't need to specify
        the <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/asynchronous_operations.html#boost_asio.reference.asynchronous_operations.completion_tokens_and_handlers" target="_top"><span class="emphasis"><em>CompletionToken</em></span></a>
        parameter in initiating functions, and the default will be used. <a class="link" href="examples/default_completion_tokens.html" title="Default completion tokens">This
        example</a> demonstrates using default completion tokens with <a class="ulink" href="https://anarthal.github.io/boost/index.html" target="_top">Boost.Mysql</a>.
      </p>
</div>
<div class="section">
<div class="titlepage"><div><div><h3 class="title">
<a name="mysql.async.cancellations_and_timeouts"></a><a class="link" href="async.html#mysql.async.cancellations_and_timeouts" title="Cancellations and timeouts">Cancellations
      and timeouts</a>
</h3></div></div></div>
<p>
        All async operations in this library support <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/overview/core/cancellation.html" target="_top">per-operation
        cancellation</a>. All operations support only the <code class="computeroutput"><span class="identifier">terminal</span></code>
        <a class="ulink" href="https://www.boost.org/doc/libs/1_80_0/doc/html/boost_asio/reference/cancellation_type.html" target="_top"><code class="literal">boost::asio::cancellation_type</code></a>.
        This means that, if an async operation is cancelled, the <a class="link" href="ref/boost__mysql__connection.html" title="connection"><code class="literal">connection</code></a>
        object is left in an unspecified state, after which you should close or destroy
        the connection. In particular, it is <span class="bold"><strong>not</strong></span>
        safe to retry the cancelled operation.
      </p>
<p>
        Supporting cancellation allows you to implement timeouts without explicit
        support from the library. <a class="link" href="examples/timeouts.html" title="Timeouts">This example</a>
        demonstrates how to implement this pattern.
      </p>
<p>
        Note that cancellation happens at the Boost.Asio level, and not at the MySQL
        operation level. This means that, when cancelling an operation, the current
        network read or write will be cancelled. The operation may have already reached
        the server and be executed. As stated above, after an operation is cancelled,
        the connection is left in an unspecified state, and you should close or destroy
        it.
      </p>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer"></div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="fields.html"><img src="../images/prev.png" alt="Prev"></a><a accesskey="u" href="../index.html"><img src="../images/up.png" alt="Up"></a><a accesskey="h" href="../index.html"><img src="../images/home.png" alt="Home"></a><a accesskey="n" href="ssl.html"><img src="../images/next.png" alt="Next"></a>
</div>
</body>
</html>
